ARG TARGETPLATFORM=linux/amd64

ARG OS=ubuntu

FROM falkordb/falkordb-build:$OS AS builder

ARG DEBUG=0

WORKDIR /FalkorDB

COPY . /FalkorDB

RUN echo "Building on OS: $OS"

# if os is ubuntu, use apt to install wget
RUN if [ "$OS" = "ubuntu" ]; then \
        apt install -y wget; \
    fi

# if os is rhel, use yum to install wget
RUN if [ "$OS" = "rhel" ]; then \
        yum install -y wget; \
    fi

RUN chmod +x ./deps/RediSearch/.install/install_cmake.sh

RUN ./deps/RediSearch/.install/install_cmake.sh

RUN make DEBUG=$DEBUG

RUN mkdir -p /FalkorDB/bin/src && cp -r /FalkorDB/bin/linux*/src/falkordb.so /FalkorDB/bin/src/falkordb.so