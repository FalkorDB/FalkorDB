name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v4.14.5)'
        required: true

jobs:
  update-formula:
    runs-on: macos-latest
    steps:
      - name: Checkout FalkorDB repository
        uses: actions/checkout@v5
        with:
          ref: master

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_ENV

      - name: Download release tarball and calculate SHA256
        id: sha256
        run: |
          TARBALL_URL="https://github.com/FalkorDB/FalkorDB/archive/refs/tags/${{ env.VERSION }}.tar.gz"
          curl -L -o release.tar.gz "${TARBALL_URL}"
          SHA256=$(shasum -a 256 release.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_ENV
          echo "Calculated SHA256: ${SHA256}"

      - name: Update formula
        run: |
          FORMULA_FILE="Formula/falkordb.rb"
          
          # Update version in URL
          sed -i '' "s|url \".*\"|url \"https://github.com/FalkorDB/FalkorDB/archive/refs/tags/${{ env.VERSION }}.tar.gz\"|" $FORMULA_FILE
          
          # Update SHA256
          sed -i '' "s|sha256 \".*\"|sha256 \"${{ env.SHA256 }}\"|" $FORMULA_FILE
          
          echo "Updated formula:"
          cat $FORMULA_FILE

      - name: Test formula locally
        run: |
          brew install --build-from-source Formula/falkordb.rb || echo "Build test failed, will still create PR"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Homebrew formula to ${{ env.VERSION }}"
          title: "chore: update Homebrew formula to ${{ env.VERSION }}"
          body: |
            Updates the Homebrew formula to version ${{ env.VERSION }}.
            
            - Version: ${{ env.VERSION }}
            - SHA256: ${{ env.SHA256 }}
            
            This PR was automatically generated by the Homebrew workflow.
          branch: homebrew-${{ env.VERSION }}
          delete-branch: true
          labels: |
            dependencies
            homebrew

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v5
        if: ${{ vars.HOMEBREW_TAP_ENABLED == 'true' }}
        with:
          repository: FalkorDB/homebrew-falkordb
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update tap formula
        if: ${{ vars.HOMEBREW_TAP_ENABLED == 'true' }}
        run: |
          cp Formula/falkordb.rb homebrew-tap/Formula/falkordb.rb
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/falkordb.rb
          git commit -m "chore: update FalkorDB formula to ${{ env.VERSION }}"
          git push
